# Phase 2.1: Hybrid Position Sync (Stream + Queue)

## Overview

Redesign position synchronization to use **hybrid approach**:
- **Active strategy contracts** → STREAM (real-time updates, consume slots)
- **Non-essential contracts** → QUEUE (Delta Lake table, processed later, 0 slots)

This conserves streaming slots while ensuring active strategies get real-time updates.

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    IBPositionStreamer                        │
│  ┌─────────────────┐         ┌─────────────────┐            │
│  │   STREAM PATH   │         │   QUEUE PATH    │            │
│  │  (Active Strat)  │         │  (Non-Essential) │            │
│  └────────┬────────┘         └────────┬────────┘            │
│           │                           │                       │
│           v                           v                       │
│  ┌─────────────┐           ┌─────────────────┐              │
│  │  reqMktData │           │ PositionQueue   │              │
│  │  (real-time)│           │ (Delta Lake)    │              │
│  └─────────────┘           └─────────────────┘              │
│           │                           │                       │
│           │                           v                       │
│           │                  ┌─────────────────┐              │
│           │                  │ QueueWorker     │              │
│           │                  │ (background)    │              │
│           │                  └─────────────────┘              │
│           │                           │                       │
│           └───────────┬───────────────┘                       │
│                       v                                       │
│              ┌─────────────────┐                              │
│              │   Handlers      │                              │
│              │ (DeltaWriter,   │                              │
│              │  Reconciliation)│                              │
│              └─────────────────┘                              │
└─────────────────────────────────────────────────────────────┘
```

## Components

### 1. StrategyRegistry
Track which contracts are in active strategies.
- **Purpose:** Determine which contracts need streaming vs queueing
- **Storage:** In-memory cache + Delta Lake `active_strategies` table
- **API:** `is_active(conid)`, `add_active(conid)`, `remove_active(conid)`

### 2. PositionQueue (Delta Lake)
Persistent queue for non-essential position updates.
- **Table:** `position_queue` in Delta Lake
- **Schema:** request_id, conid, priority, status, created_at, updated_at
- **Priorities:** 1=active (streamed directly), 2=monitoring (queued)

### 3. IBPositionStreamer (Redesigned)
Hybrid logic: stream active, queue non-active.
- **Stream path:** `reqMktData()` for active strategy contracts
- **Queue path:** Insert into `position_queue` for non-essential
- **Decision logic:** Check `StrategyRegistry.is_active(conid)`

### 4. QueueWorker (Background Daemon)
Process queued position updates.
- **Poll interval:** 5 seconds (configurable)
- **Batch size:** 50 contracts per batch
- **Processing:** Fetch position → Update Delta Lake → Mark processed

### 5. DeltaLakePositionWriter (No Changes)
Still receives position updates via handler registration.
- Works with both streamed and queued updates
- No code changes needed (backward compatible)

## Phase 2.1 Plans

### Plan 2.1-01: Create StrategyRegistry and PositionQueue
- Create `StrategyRegistry` class with active contract tracking
- Create `PositionQueue` Delta Lake table and class
- Create `position_queue` table schema
- Implement queue operations (insert, get_batch, mark_processed)

### Plan 2.1-02: Redesign IBPositionStreamer with Hybrid Logic
- Refactor `IBPositionStreamer` to use hybrid approach
- Implement streaming path for active contracts
- Implement queue path for non-essential contracts
- Update integration test

### Plan 2.1-03: Implement QueueWorker Background Daemon
- Create `QueueWorker` class for processing queue
- Implement batch processing with configurable interval
- Add error handling and retry logic
- Create daemon process management

### Plan 2.1-04: Integration Testing and Documentation
- Update integration tests for hybrid approach
- Create end-to-end test (stream + queue)
- Update documentation (STREAMING_SLOTS_ISSUE.md, STATE.md, ROADMAP.md)
- Create architecture diagram

## Dependencies

- **Depends on:** Phase 2 (Position Synchronization) - 02-01, 02-02, 02-03
- **Blocks:** Phase 3 (Decision Rules Engine)

## Success Criteria

- [ ] Active strategy contracts streamed in real-time
- [ ] Non-essential contracts queued (0 slots consumed)
- [ ] Queue worker processes batch every 5 seconds
- [ ] DeltaLakePositionWriter works with both paths
- [ ] All verification checks pass
- [ ] Documentation updated

## Estimated Effort

- **Plan 2.1-01:** 2-3 hours (StrategyRegistry, PositionQueue)
- **Plan 2.1-02:** 2-3 hours (IBPositionStreamer redesign)
- **Plan 2.1-03:** 2-3 hours (QueueWorker daemon)
- **Plan 2.1-04:** 1-2 hours (testing, documentation)

**Total:** 7-11 hours (1-2 days)

---

**Created:** 2026-01-26
**Status:** Ready for execution
**Urgency:** Critical (architectural redesign for slot conservation)
